# Правило: Суперадмін — окрема платформа та ідентичність

Це правило фіксує архітектурне рішення: суперадмін — це окремий користувач і окрема платформа керування тенантами/клініками. Суперадмін не є лікарем і не належить до жодного тенанта.

## 1) Ідентичність та таблиці
- Суперадмін зберігається в таблиці `admin_users` (див. міграцію `1736090800000-add-admin-users.ts`).
- Поля: `id`, `email` (унікальний), `fullName`, `passwordHash`, `active`, `createdAt`, `updatedAt`.
- Лікарі (`doctors`) і суперадміни (`admin_users`) — різні типи користувачів. Вони НЕ перетинаються.

## 2) Модулі та розміщення коду
- Суперадмінська автентифікація: `src/sa-auth/*` (`SaAuthModule`, `AdminUser`, `SaJwtStrategy`, `SaJwtAuthGuard`).
- Суперадмінські бізнес-ендпоінти: `src/sa/*` (`SaModule`, `SaController`, `SaService`).
- CRUD для тенантів розміщується у `src/tenants/*`, але доступ до нього — лише для суперадміна.

## 3) Авторизація та токени
- Суперадмін логіниться через `POST /sa/auth/login` і отримує Bearer-токен зі стратегією `sa-jwt` та пейлоадом `{ isSa: true }`.
- Лише `SaJwtAuthGuard` має відкривати доступ до:
  - усіх роутів під префіксом `/sa/*` (напр., статистика);
  - CRUD `/tenants/*`.
- Токени лікаря (модуль `auth`) НІКОЛИ не мають прапорця суперадміна. Поле `isSuperAdmin` у `JwtUser` повинно бути `false` для лікарських токенів.

## 4) Swagger та схеми авторизації
- У `src/main.ts` мають бути визначені дві схеми:
  - `bearer` — для лікарських токенів;
  - `sa-bearer` — для суперадмінських токенів.
- Суперадмінські контролери позначати `@ApiBearerAuth('sa-bearer')` та тегом `sa`.

## 5) Контекст тенанта та імперсонація
- `TenantGuard`/`TenantInterceptor` застосовуються до модулів лікарів (тенантських), не до `/sa/*`.
- Суперадмінські токени не використовуються у тенантських роутерах напряму.
- Імперсонація дій від імені конкретного тенанта виконується або окремим ендпоінтом видачі тимчасового tenant-JWT, або прокиданням `x-tenant-id` тільки там, де це явно дозволено бізнес-вимогами. За замовчуванням — заборонено.

## 6) Безпека та межі доступу
- Тенант не може «піднятися» до суперадміна створенням ролі у своїй БД. Будь-яка логіка, яка базувалась на `roleSlug === 'super_admin'` у лікарів — заборонена.
- CRUD `/tenants/*` та `/sa/*` завжди захищені лише `SaJwtAuthGuard`.

## 7) База даних та міграції
- `synchronize` завжди `false` у проді. Для змін у схемі — тільки через міграції TypeORM.
- Будь-які зміни у `admin_users` — лише через міграції.

## 8) Фронтенд та домени
- Суперадмінська SPA — окремий застосунок/домен (напр., `admin.yourdomain.com`).
- Тенантська консоль — інший застосунок/домен (напр., `app.yourdomain.com`).
- CORS повинен дозволяти домен(и) суперадмінки.

## 9) Дизайн ендпоінтів
- Суперадмінські ендпоінти — під префіксом `/sa/*` (напр., `GET /sa/stats/overview`, `GET /sa/tenants/:id/stats`).
- CRUD тенантів — `/tenants/*`, доступні лише суперадміну.

## 10) Заборонено
- Змішувати лікарські та суперадмінські токени.
- Додавати суперадмінські прапорці або ролі у таблицю лікарів.
- Обʼєднувати платформи (UI або бекенд-роути) без чіткого поділу й гардінгу.


